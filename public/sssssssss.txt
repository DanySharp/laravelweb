<?php

namespace App\Http\Controllers\Front;

use App\Http\Controllers\Controller;
use App\Models\ActivationCode;
use Illuminate\Http\Request;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Redirect;
use Illuminate\Support\Facades\Session;
use Trez\RayganSms\Facades\RayganSms;

class PhoneController extends Controller
{
    public function index()
    {
        return view('layouts.phone');
    }




    public function SendAuthCode(Request $request)
    {
        $user = auth()->user();

        session(['phone'=>$user->phone]);
        RayganSms::sendAuthCode($user->phone,'WebRich.ir');

        session::put('key_send');
        return redirect()->back()->with('key_send', 'پیامک ارسال شد');
//
//        session(['phone'=>$request->phone]);
//
//        RayganSms::sendAuthCode($request->phone,'WebRich.ir');
//        session::put('key_send');
//        return redirect()->back()->with('key_send', 'پیامک ارسال شد');

    }







    public function phoneVerifiedAt(Request $request)
    {

        $request->user()->update([

            'phone_verified' => Carbon::now()
        ]);

        Session::flash('sentsms','تایید انجام شد');
      //  return  Redirect::back()->with('sentsms', 'موبایل شما تایید شد');
     //   return redirect(url('/blog'));
        return redirect()->refresh();   
    }



    public function verifyByPhone(Request $request)
    {
//        $result = RayganSms::checkAuthCode(\session('phone'),$request->verification_code);
//        if (!$result) {
//            return back()->withErrors(['msg', 'Invalid Code Please Try Again!']);
//        }
//
//        if ($request->user()->phone_verified()) {
//            return redirect()->route('/panel');
//        }
//
//        $request->user()->phoneVerifiedAt();

        $request->validate([

            'verification_code' => ['required', 'numeric','min:8'],

            ],
            [
                 'verification_code.required'=>' کد پیامکی را وارد نکردید ',
                 'verification_code.numeric'=>' فقط اعداد مجاز هستند ',


           ]);


        $result = RayganSms::checkAuthCode(session('phone'),$request->verification_code);
        if ($result){
            $this->phoneVerifiedAt();
        }
        else{
            return Redirect::back()->with('message',' کد وارد شده صحیح نمی باشد !');
        }

        //return redirect(url('/blog'));
        return redirect()->refresh();

    }
}
